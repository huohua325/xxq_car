# xxq_host 用户手册

## 📖 目录

1. [快速开始](#快速开始)
2. [安装配置](#安装配置)
3. [基础使用](#基础使用)
4. [高级功能](#高级功能)
5. [常见问题](#常见问题)
6. [故障排除](#故障排除)

---

## 快速开始

### 30秒上手

```bash
# 1. 克隆项目
cd xxq_host

# 2. 安装依赖
pip install -r requirements.txt

# 3. 运行演示
python scripts/demo_exploration.py
```

就这么简单！🎉

---

## 安装配置

### 系统要求

- **操作系统**: Windows / Linux / macOS
- **Python**: 3.11 或更高
- **内存**: 建议 4GB+
- **硬盘**: 500MB 可用空间

### 安装步骤

#### 1. Python环境检查

```bash
python --version
# 应显示: Python 3.11.x 或更高
```

#### 2. 安装依赖包

```bash
pip install -r requirements.txt
```

依赖包列表:
- `numpy` - 数值计算
- `matplotlib` - 可视化
- `pytest` - 测试框架

#### 3. 验证安装

```bash
python -m pytest tests/ -v
```

看到所有测试通过 (53 passed) 即为成功！✅

---

## 基础使用

### 1. SLAM建图

#### 创建地图

```python
from slam.occupancy_map import OccupancyGridMap, MapConfig

# 配置地图参数
config = MapConfig(
    width=500,          # 宽度: 500格
    height=500,         # 高度: 500格  
    resolution=0.1      # 分辨率: 0.1米/格
)

# 创建地图
slam_map = OccupancyGridMap(config)
```

#### 更新地图

```python
from communication.protocol import LidarData

# 雷达数据
lidar = LidarData(
    timestamp=1000,
    total_points=800,
    angle_coverage=360.0,
    sectors=[...]
)

# 机器人位姿
robot_pose = (0.0, 0.0, 0.0)  # (x, y, theta)

# 更新地图
slam_map.update_with_lidar(lidar, robot_pose)
```

#### 保存/加载地图

```python
# 保存
slam_map.save_map('data/maps/my_map.npy')

# 加载
slam_map.load_map('data/maps/my_map.npy')
```

### 2. 前沿探索

#### 查找未探索区域

```python
from slam.frontier_detector import FrontierDetector

# 创建探测器
detector = FrontierDetector(slam_map)

# 查找前沿点
frontiers = detector.find_frontiers(robot_pose)
print(f"发现 {len(frontiers)} 个前沿点")
```

#### 选择探索目标

```python
# 策略1: 最近的前沿点
target = detector.select_best_frontier(
    frontiers, robot_pose, 
    strategy='nearest'
)

# 策略2: 最大的前沿簇
target = detector.select_best_frontier(
    frontiers, robot_pose, 
    strategy='largest'
)

# 策略3: 信息增益最大
target = detector.select_best_frontier(
    frontiers, robot_pose, 
    strategy='information_gain'
)
```

### 3. 路径规划

#### 全局路径规划 (A*)

```python
from navigation.path_planner import PathPlanner

planner = PathPlanner(slam_map)

# 规划路径
start = (0.0, 0.0)
goal = (5.0, 5.0)
path = planner.plan_path(start, goal)

if path:
    print(f"路径长度: {len(path)} 点")
else:
    print("无法找到路径")
```

#### 路径平滑

```python
# 原始路径可能有很多点
smooth_path = planner.smooth_path(path)
print(f"平滑后: {len(path)} → {len(smooth_path)} 点")
```

#### 局部避障 (DWA)

```python
from navigation.dwa import DWA

dwa = DWA(slam_map)

# 计算最优速度
robot_pose = (0.0, 0.0, 0.0)
current_v = 0.5  # 当前速度
current_w = 0.0  # 当前角速度
goal = (5.0, 5.0)

best_v, best_w = dwa.plan(robot_pose, current_v, current_w, goal)

if best_v is not None:
    print(f"建议速度: {best_v:.2f} m/s")
    print(f"建议角速度: {best_w:.2f} deg/s")
```

### 4. 可视化

#### 基本可视化

```python
from visualization.map_visualizer import MapVisualizer

# 创建可视化器
viz = MapVisualizer(slam_map)

# 更新显示
viz.update(robot_pose)

# 保存截图
viz.save_screenshot('output.png')
```

#### 高级可视化

```python
# 显示所有元素
viz.update(
    robot_pose,
    lidar_points=lidar_points,  # 雷达点云
    path=path,                  # 规划路径
    frontiers=frontiers         # 前沿点
)
```

---

## 高级功能

### 完整自主探索

```python
from navigation.controller import RobotController

# 创建控制器
controller = RobotController(
    slam_map=slam_map,
    visualize=True  # 启用可视化
)

# 运行探索
controller.run_exploration(
    initial_pose=(0.0, 0.0, 0.0),
    max_steps=1000
)

# 查看探索统计
stats = controller.get_statistics()
print(f"探索步数: {stats['exploration_steps']}")
print(f"移动距离: {stats['total_distance']:.2f}m")
```

### 自定义参数

修改 `config.py` 中的参数:

```python
# 地图参数
MAP_WIDTH = 500
MAP_HEIGHT = 500
MAP_RESOLUTION = 0.1

# DWA参数
MAX_SPEED = 1.0          # 最大速度 (m/s)
MAX_YAW_RATE = 40.0      # 最大角速度 (deg/s)
MAX_ACCEL = 0.5          # 最大加速度 (m/s²)

# Frontier参数
FRONTIER_CLUSTER_DIST = 0.3  # 聚类距离 (m)
MIN_FRONTIER_SIZE = 5        # 最小簇大小

# 选择策略: 'nearest' | 'largest' | 'information_gain'
FRONTIER_SELECTION = 'nearest'
```

### 调试模式

```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 单步调试
controller = RobotController(slam_map, visualize=True)
controller.current_pose = (0.0, 0.0, 0.0)

# 执行单步
state = controller._control_step()
print(f"当前状态: {state}")
```

---

## 运行演示

### 演示1: Frontier探索

```bash
python scripts/demo_frontier.py
```

展示内容:
- ✅ 基本前沿检测
- ✅ 前沿聚类
- ✅ 选择策略对比
- ✅ 复杂场景探索

### 演示2: 路径规划

```bash
python scripts/demo_path_planning.py
```

展示内容:
- ✅ A*全局规划
- ✅ 路径平滑
- ✅ DWA局部避障
- ✅ 障碍物膨胀
- ✅ 完整导航流程

### 演示3: 完整探索

```bash
python scripts/demo_exploration.py
```

展示内容:
- ✅ 简单环境探索
- ✅ 复杂环境探索
- ✅ 状态机转换
- ✅ 实时可视化

### 演示4: 可视化

```bash
python scripts/demo_visualization.py
```

展示内容:
- ✅ 基本地图显示
- ✅ 轨迹记录
- ✅ 多元素显示
- ✅ 交互功能

---

## 常见问题

### Q1: 如何调整地图大小？

**A**: 修改 `config.py` 中的参数:

```python
MAP_WIDTH = 1000   # 更大的地图
MAP_HEIGHT = 1000
MAP_RESOLUTION = 0.05  # 更高的分辨率
```

### Q2: 如何加快探索速度？

**A**: 调整以下参数:

```python
# 增加机器人速度
MAX_SPEED = 2.0  # 默认1.0

# 减小前沿簇要求
MIN_FRONTIER_SIZE = 3  # 默认5

# 使用最近策略
FRONTIER_SELECTION = 'nearest'
```

### Q3: 路径规划失败怎么办？

**A**: 检查以下几点:

1. **目标可达性**: 确保目标点在自由空间
2. **障碍物**: 检查是否有障碍物阻挡
3. **安全距离**: 减小 `safety_distance` 参数

```python
planner = PathPlanner(slam_map, safety_distance=0.1)
```

### Q4: 如何保存探索结果？

**A**: 使用地图保存功能:

```python
# 保存地图
slam_map.save_map('data/maps/exploration_result.npy')

# 保存可视化截图
viz.save_screenshot('data/maps/exploration_viz.png')
```

### Q5: DWA找不到速度怎么办？

**A**: 可能的原因:

1. **动态窗口太小**: 增加预测时间
```python
dwa = DWA(slam_map, predict_time=2.0)  # 默认1.0
```

2. **障碍物太近**: 降低速度
```python
current_v = 0.3  # 降低当前速度
```

3. **目标太远**: 使用全局路径的下一个点作为目标

### Q6: 如何调试前沿检测？

**A**: 使用可视化查看:

```python
frontiers, info = detector.find_frontiers(robot_pose, return_info=True)

print(f"前沿点数: {len(frontiers)}")
print(f"簇数量: {len(info['clusters'])}")
print(f"簇大小: {info['cluster_sizes']}")

# 可视化
viz.update(robot_pose, frontiers=frontiers)
```

---

## 故障排除

### 问题1: 导入错误

```python
ModuleNotFoundError: No module named 'numpy'
```

**解决**: 安装依赖包
```bash
pip install -r requirements.txt
```

### 问题2: 测试失败

```bash
FAILED tests/test_slam.py::test_map_creation
```

**解决**: 
1. 检查Python版本 (需要3.11+)
2. 重新安装依赖
3. 查看详细错误信息:
```bash
pytest tests/test_slam.py -v --tb=long
```

### 问题3: 可视化不显示

**可能原因**: matplotlib后端问题

**解决**:
```python
import matplotlib
matplotlib.use('TkAgg')  # 或 'Qt5Agg'
```

### 问题4: 内存不足

**症状**: 程序运行变慢或崩溃

**解决**:
1. 减小地图尺寸
```python
config = MapConfig(width=200, height=200)  # 原500x500
```

2. 降低可视化频率
```python
if step % 10 == 0:  # 每10步可视化一次
    viz.update(robot_pose)
```

### 问题5: 路径规划太慢

**优化方法**:

1. **降低地图分辨率**
```python
config = MapConfig(resolution=0.2)  # 原0.1
```

2. **减小搜索范围**
```python
# 使用局部地图
local_map = get_local_map(robot_pose, radius=10.0)
```

3. **启用路径缓存**
```python
if not path or path_invalid:
    path = planner.plan_path(start, goal)
```

---

## 性能优化建议

### 1. 地图更新优化

```python
# 批量更新而不是逐点更新
slam_map.update_with_lidar(lidar, robot_pose)  # ✅ 好
# 避免:
for point in lidar_points:
    slam_map.update_cell(...)  # ❌ 慢
```

### 2. 前沿检测优化

```python
# 设置合理的聚类距离
detector = FrontierDetector(
    slam_map, 
    cluster_distance=0.3  # 太小会产生过多簇
)
```

### 3. 路径规划优化

```python
# 使用路径验证避免重复规划
if planner.is_path_valid(current_path):
    # 继续使用当前路径
    pass
else:
    # 重新规划
    current_path = planner.plan_path(start, goal)
```

### 4. 可视化优化

```python
# 控制刷新频率
if time.time() - last_viz_time > 0.033:  # 30fps
    viz.update(robot_pose)
    last_viz_time = time.time()
```

---

## 最佳实践

### ✅ 推荐做法

1. **使用配置文件**: 集中管理参数
2. **启用日志**: 便于调试
3. **定期保存**: 保存地图和探索进度
4. **模块化测试**: 单独测试每个模块
5. **可视化验证**: 通过可视化检查结果

### ❌ 避免做法

1. **硬编码参数**: 难以调整和维护
2. **忽略异常**: 可能导致不可预测的行为
3. **过度可视化**: 影响性能
4. **跳过测试**: 可能引入bug
5. **不保存进度**: 浪费探索时间

---

## 扩展开发

### 添加自定义策略

```python
class MyFrontierSelector:
    def select(self, frontiers, robot_pose):
        # 自定义选择逻辑
        return best_frontier

# 使用
detector.custom_selector = MyFrontierSelector()
```

### 集成硬件

```python
from communication.robot_comm import RobotComm

# 连接机器人
comm = RobotComm(port='COM5', baudrate=115200)
comm.connect()

# 发送导航命令
comm.send_navigation_command(x=1.0, y=1.0, theta=0, speed=0.5)

# 接收传感器数据
lidar = comm.get_latest_lidar()
odom = comm.get_latest_odometry()
```

---

## 获取帮助

### 文档

- **API文档**: `doc/API文档.md`
- **开发计划**: `doc/开发计划.md`
- **测试指南**: `doc/测试指南.md`

### 测试

```bash
# 运行所有测试
pytest tests/ -v

# 运行特定测试
pytest tests/test_slam.py::test_map_creation -v
```

### 演示脚本

所有演示脚本都在 `scripts/` 目录下:
- `demo_frontier.py`
- `demo_path_planning.py`
- `demo_exploration.py`
- `demo_visualization.py`

---

## 附录

### A. 坐标系统

- **世界坐标**: 米 (m), 原点在地图中心
- **栅格坐标**: 格 (grid), 整数索引
- **角度**: 度 (deg), 0度为东方向，逆时针为正

### B. 数据格式

**地图格式**: NumPy数组 (.npy)
```python
# 栅格值:
# -inf ~ -50: 自由空间
# -50 ~ 50: 未知
# 50 ~ +inf: 障碍物
```

**位姿格式**: `(x, y, theta)`
```python
# x, y: 世界坐标 (m)
# theta: 朝向角度 (deg)
```

### C. 常用快捷键

可视化窗口:
- **空格**: 暂停/继续
- **R**: 重置
- **S**: 保存截图
- **Q**: 退出

---

**版本**: 1.0.0  
**最后更新**: 2025-10-09

祝你使用愉快！🚀

