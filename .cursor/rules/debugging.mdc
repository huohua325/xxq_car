---
description: Debugging and troubleshooting guidelines for hardware and software issues
---

# è°ƒè¯•ä¸æ•…éšœæ’æŸ¥æŒ‡å—

æœ¬è§„åˆ™æä¾›ç³»ç»Ÿè°ƒè¯•å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆã€‚

## å¿«é€Ÿè¯Šæ–­æµç¨‹

### 1. ç³»ç»Ÿå¥åº·æ£€æŸ¥
```bash
# è¿è¡Œå¿«é€Ÿç³»ç»Ÿæµ‹è¯•ï¼ˆ5åˆ†é’Ÿï¼‰
python tests/test_system_comprehensive.py --port COM5 --quick

# é¢„æœŸè¾“å‡ºï¼š
# âœ… ä¸²å£è¿æ¥æˆåŠŸ
# âœ… æ¥æ”¶åˆ°ä½å§¿æ•°æ®
# âœ… æ¥æ”¶åˆ°MPUæ•°æ®
# âœ… æ¥æ”¶åˆ°é‡Œç¨‹è®¡æ•°æ®
# âœ… é›·è¾¾æ‰«ææˆåŠŸ
```

### 2. åˆ†å±‚è¯Šæ–­

**Level 1: ç¡¬ä»¶è¿æ¥**
```python
# æ£€æŸ¥ä¸²å£è¿æ¥
python scripts/find_stm32_port.py

# æˆ–æ‰‹åŠ¨æµ‹è¯•
import serial
ser = serial.Serial('COM5', 115200, timeout=1)
print(ser.readline())  # åº”è¯¥çœ‹åˆ°æ•°æ®æµ
```

**Level 2: æ•°æ®æµ**
```bash
# æŸ¥çœ‹åŸå§‹æ•°æ®ï¼ˆWindowsï¼‰
mode COM5: BAUD=115200 PARITY=N DATA=8 STOP=1
type COM5

# æˆ–ä½¿ç”¨Pythonè„šæœ¬
python scripts/test_stage1_communication.py
```

**Level 3: æ¨¡å—åŠŸèƒ½**
```bash
# æµ‹è¯•ä½å§¿ä¼°è®¡
python scripts/test_pose_estimation.py

# æµ‹è¯•SLAMå»ºå›¾
pytest tests/test_slam.py -v

# æµ‹è¯•è·¯å¾„è§„åˆ’
pytest tests/test_navigation.py -v
```

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### ğŸ”´ é—®é¢˜1: æ— æ³•è¿æ¥ä¸²å£

**ç—‡çŠ¶**:
```
serial.SerialException: could not open port 'COM5': 
PermissionError: [Errno 13] Permission denied
```

**åŸå› **:
- ä¸²å£å·²è¢«å…¶ä»–ç¨‹åºå ç”¨
- é©±åŠ¨æœªæ­£ç¡®å®‰è£…
- æƒé™ä¸è¶³ï¼ˆLinuxï¼‰

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. æ£€æŸ¥ç«¯å£å ç”¨
python scripts/find_stm32_port.py

# 2. å…³é—­å ç”¨ç«¯å£çš„ç¨‹åº
# - Arduino IDE
# - PuTTY / TeraTerm
# - å…¶ä»–Pythonè„šæœ¬

# 3. Linuxæƒé™é—®é¢˜
sudo usermod -a -G dialout $USER  # æ·»åŠ ç”¨æˆ·åˆ°dialoutç»„
sudo chmod 666 /dev/ttyUSB0       # æˆ–ç›´æ¥ä¿®æ”¹æƒé™
```

### ğŸ”´ é—®é¢˜2: æ¥æ”¶ä¸åˆ°æ•°æ®

**ç—‡çŠ¶**:
```python
# read_sensor_data() è¿”å› None
data = comm.read_sensor_data(timeout=5.0)
assert data is None  # è¶…æ—¶
```

**è¯Šæ–­æ­¥éª¤**:
1. **æ£€æŸ¥å›ºä»¶æ˜¯å¦è¿è¡Œ**
   ```
   # STM32è°ƒè¯•å™¨ä¸­æ£€æŸ¥ä¸»å¾ªç¯æ˜¯å¦æ‰§è¡Œ
   # æˆ–è§‚å¯ŸLEDæ˜¯å¦é—ªçƒ
   ```

2. **æ£€æŸ¥æ³¢ç‰¹ç‡åŒ¹é…**
   ```python
   # config.py
   SERIAL_BAUDRATE = 115200  # å¿…é¡»ä¸å›ºä»¶ä¸€è‡´
   ```

3. **æ£€æŸ¥UARTé…ç½®**
   ```c
   // xxq/Core/Src/usart.c
   huart4.Init.BaudRate = 115200;
   huart4.Init.WordLength = UART_WORDLENGTH_8B;
   huart4.Init.StopBits = UART_STOPBITS_1;
   huart4.Init.Parity = UART_PARITY_NONE;
   ```

4. **ä½¿ç”¨è°ƒè¯•å‘½ä»¤**
   ```python
   # å‘é€ç®€å•å‘½ä»¤æµ‹è¯•é€šä¿¡
   ser.write(b'?')  # è¯·æ±‚å¸®åŠ©
   print(ser.read(100))  # åº”è¯¥æ”¶åˆ°å“åº”
   ```

### ğŸ”´ é—®é¢˜3: æœºå™¨äººä¸åŠ¨æˆ–è¿åŠ¨å¼‚å¸¸

**ç—‡çŠ¶**:
- å‘é€é€Ÿåº¦å‘½ä»¤ä½†ç”µæœºä¸è½¬
- æœºå™¨äººè½¬å‘é”™è¯¯
- ç›´çº¿è¡Œé©¶åç¦»

**è¯Šæ–­æ­¥éª¤**:
1. **æµ‹è¯•ç”µæœºé©±åŠ¨**
   ```python
   # ç›´æ¥å‘é€é€Ÿåº¦å‘½ä»¤
   comm.send_speed_command(1.0, 1.0)  # å·¦å³è½®ç›¸åŒé€Ÿåº¦
   
   # è§‚å¯Ÿï¼š
   # - ä¸¤è½®æ˜¯å¦åŒæ—¶è½¬åŠ¨
   # - è½¬é€Ÿæ˜¯å¦ç›¸è¿‘
   # - æ–¹å‘æ˜¯å¦æ­£ç¡®
   ```

2. **æ£€æŸ¥ç¼–ç å™¨åé¦ˆ**
   ```python
   # æŸ¥çœ‹é‡Œç¨‹è®¡æ•°æ®
   odo = comm.read_odometry()
   print(f"å·¦è½®: {odo['left_rps']:.2f} RPS")
   print(f"å³è½®: {odo['right_rps']:.2f} RPS")
   
   # é¢„æœŸï¼šå‘é€1.0 RPSå‘½ä»¤æ—¶ï¼Œåº”è¯¥æ¥æ”¶åˆ°~1.0 RPSåé¦ˆ
   ```

3. **æ ¡éªŒç‰©ç†å‚æ•°**
   ```python
   # æ£€æŸ¥WHEEL_BASEå’ŒWHEEL_RADIUSæ˜¯å¦æ­£ç¡®
   from config import WHEEL_BASE, WHEEL_RADIUS
   print(f"è½®è·: {WHEEL_BASE}m")
   print(f"è½®åŠå¾„: {WHEEL_RADIUS}m")
   
   # å®é™…æµ‹é‡æœºå™¨äººå¹¶å¯¹æ¯”
   ```

4. **è¿è¡ŒPWMæ ‡å®š**
   ```bash
   python pwm_calibration.py
   # æ£€æŸ¥PWMä¸é€Ÿåº¦çš„çº¿æ€§å…³ç³»
   ```

### ğŸ”´ é—®é¢˜4: é›·è¾¾æ•°æ®å¼‚å¸¸

**ç—‡çŠ¶**:
- é›·è¾¾è¿”å›ç©ºæ•°æ®
- è·ç¦»å€¼å…¨ä¸º0æˆ–å¼‚å¸¸å¤§
- JSONè§£æå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. æ‰‹åŠ¨è§¦å‘æ‰«æ
comm.request_lidar_scan()
time.sleep(2)  # ç­‰å¾…æ‰«æå®Œæˆ
data = comm.read_lidar_data()

# 2. æ£€æŸ¥JSONæ ¼å¼
import json
try:
    parsed = json.loads(raw_data)
except json.JSONDecodeError as e:
    print(f"JSONè§£æé”™è¯¯: {e}")
    print(f"åŸå§‹æ•°æ®: {raw_data}")

# 3. éªŒè¯æ‰‡åŒºæ•°æ®
if 'sectors' in data:
    for sector in data['sectors']:
        print(f"æ‰‡åŒº{sector['sector_id']}: "
              f"ç‚¹æ•°={sector['count']}, "
              f"å¹³å‡è·ç¦»={sector['avg_dist']:.2f}m")
```

### ğŸ”´ é—®é¢˜5: ä½å§¿ä¼°è®¡æ¼‚ç§»

**ç—‡çŠ¶**:
- æœºå™¨äººé™æ­¢æ—¶ä½å§¿ä»åœ¨å˜åŒ–
- ç›´çº¿è¡Œé©¶æ—¶Yåæ ‡å˜åŒ–
- è½¬å‘è§’åº¦ä¸å‡†ç¡®

**åŸå› **:
- ç¼–ç å™¨è„‰å†²æ•°é…ç½®é”™è¯¯
- IMUé›¶ç‚¹æ¼‚ç§»
- è½®å­æ‰“æ»‘

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. é‡ç½®ä½å§¿
comm.reset_pose(0.0, 0.0, 0.0)

# 2. é™æ€æµ‹è¯•ï¼ˆæœºå™¨äººä¸åŠ¨ï¼‰
for i in range(50):
    pose = comm.read_pose()
    print(f"{i}: x={pose['x']:.4f}, y={pose['y']:.4f}, theta={pose['theta']:.4f}")
    time.sleep(0.1)
# é¢„æœŸï¼šx, y, theta åº”è¯¥ä¿æŒä¸å˜æˆ–å¾®å°æ³¢åŠ¨

# 3. ç›´çº¿æµ‹è¯•
comm.send_speed_command(1.0, 1.0)
time.sleep(3)
comm.send_speed_command(0, 0)
final_pose = comm.read_pose()
print(f"Yåç§»: {final_pose['y']:.4f}m")  # åº”è¯¥æ¥è¿‘0

# 4. æ£€æŸ¥ç¼–ç å™¨é…ç½®
# config.py å’Œ main.c ä¸­çš„ ENCODER_PPR å¿…é¡»ä¸€è‡´
```

### ğŸ”´ é—®é¢˜6: SLAMåœ°å›¾è´¨é‡å·®

**ç—‡çŠ¶**:
- å¢™å£æ¨¡ç³Šä¸æ¸…
- å¤§é‡å™ªç‚¹
- å‰æ²¿æ£€æµ‹å¤±è´¥

**è°ƒä¼˜å‚æ•°**:
```python
# config.py

# 1. è°ƒæ•´å æ®æ¦‚ç‡é˜ˆå€¼
MAP_PROB_OCCUPIED = 0.9   # å¢å¤§å¯å‡å°‘è¯¯åˆ¤ä¸ºéšœç¢ç‰©
MAP_PROB_FREE = 0.3       # å‡å°å¯æ›´å¿«æ ‡è®°ä¸ºç©ºé—²

# 2. è°ƒæ•´åœ°å›¾åˆ†è¾¨ç‡
MAP_RESOLUTION = 0.1  # æ›´å°çš„å€¼=æ›´é«˜åˆ†è¾¨ç‡ï¼ˆä½†å ç”¨æ›´å¤šå†…å­˜ï¼‰

# 3. è°ƒæ•´å‰æ²¿æ£€æµ‹å‚æ•°
FRONTIER_CLUSTER_DIST = 3      # å‰æ²¿ç‚¹èšç±»è·ç¦»ï¼ˆæ …æ ¼æ•°ï¼‰
MIN_FRONTIER_SIZE = 10         # æœ€å°å‰æ²¿ç°‡å¤§å°
MAP_FREE_THRESHOLD = 0.3       # ç©ºé—²æ …æ ¼é˜ˆå€¼
```

### ğŸ”´ é—®é¢˜7: è·¯å¾„è§„åˆ’å¤±è´¥

**ç—‡çŠ¶**:
- `plan_path()` è¿”å› `None`
- è·¯å¾„è¿‡äºæ›²æŠ˜
- æ’å¢™æˆ–å¡ä½

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. å¯è§†åŒ–éšœç¢ç‰©åœ°å›¾
import matplotlib.pyplot as plt
plt.imshow(occupancy_map.grid > PATH_OBSTACLE_THRESHOLD)
plt.colorbar()
plt.show()

# 2. è°ƒæ•´éšœç¢ç‰©è†¨èƒ€
PATH_INFLATION_RADIUS = 3  # å¢å¤§æé«˜å®‰å…¨æ€§ï¼Œå‡å°å¯é€šè¿‡ç‹­çª„åŒºåŸŸ

# 3. å¯ç”¨å¯¹è§’çº¿ç§»åŠ¨
PATH_ALLOW_DIAGONAL = True
PATH_DIAGONAL_COST = 1.414  # âˆš2

# 4. è°ƒæ•´è·¯å¾„å¹³æ»‘
PATH_SMOOTHING_TOLERANCE = 0.5  # æ›´å¤§çš„å€¼=æ›´å¹³æ»‘ä½†å¯èƒ½åç¦»
```

### ğŸ”´ é—®é¢˜8: DWAé¿éšœä¸å·¥ä½œ

**ç—‡çŠ¶**:
- æœºå™¨äººæ’åˆ°éšœç¢ç‰©
- é€Ÿåº¦é€‰æ‹©ä¸åˆç†
- éœ‡è¡æˆ–å¡æ­»

**è°ƒè¯•ä»£ç **:
```python
from src.navigation.dwa import DWA
import matplotlib.pyplot as plt

dwa = DWA(occupancy_map)

# å¯è§†åŒ–åŠ¨æ€çª—å£
v_range, w_range = dwa.calculate_dynamic_window(current_v, current_w)
print(f"çº¿é€Ÿåº¦èŒƒå›´: {v_range}")
print(f"è§’é€Ÿåº¦èŒƒå›´: {w_range}")

# è°ƒæ•´è¯„ä»·å‡½æ•°æƒé‡
DWA_WEIGHT_HEADING = 0.1    # æœå‘å¾—åˆ†æƒé‡
DWA_WEIGHT_CLEARANCE = 0.5  # éšœç¢ç‰©è·ç¦»æƒé‡
DWA_WEIGHT_VELOCITY = 0.4   # é€Ÿåº¦å¾—åˆ†æƒé‡

# å¢å¤§å®‰å…¨è·ç¦»
DWA_MIN_CLEARANCE = 0.3  # æœ€å°å®‰å…¨è·ç¦»ï¼ˆç±³ï¼‰
```

## æ—¥å¿—è°ƒè¯•

### å¯ç”¨è¯¦ç»†æ—¥å¿—
```python
import logging

# è®¾ç½®æ—¥å¿—çº§åˆ«
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('robot_debug.log'),
        logging.StreamHandler()
    ]
)

# é’ˆå¯¹ç‰¹å®šæ¨¡å—
logging.getLogger('src.communication').setLevel(logging.DEBUG)
logging.getLogger('src.slam').setLevel(logging.INFO)
```

### æ—¥å¿—ç¤ºä¾‹
```python
logger = logging.getLogger(__name__)

def process_sensor_data(data):
    logger.debug(f"æ”¶åˆ°æ•°æ®: {data}")
    
    try:
        parsed = parse_data(data)
        logger.info(f"è§£ææˆåŠŸ: {parsed}")
    except Exception as e:
        logger.error(f"è§£æå¤±è´¥: {e}", exc_info=True)
```

## æ€§èƒ½åˆ†æ

### æµ‹é‡æ‰§è¡Œæ—¶é—´
```python
import time

def profile_function(func):
    """è£…é¥°å™¨ï¼šæµ‹é‡å‡½æ•°æ‰§è¡Œæ—¶é—´"""
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        elapsed = time.time() - start
        print(f"{func.__name__} è€—æ—¶: {elapsed:.3f}s")
        return result
    return wrapper

@profile_function
def update_map_with_lidar(lidar_data, pose):
    # ... å®ç°
    pass
```

### æ€§èƒ½åŸºå‡†
| æ“ä½œ | ç›®æ ‡æ—¶é—´ | è¶…æ—¶è­¦å‘Š |
|------|---------|---------|
| åœ°å›¾æ›´æ–° | <50ms | >100ms |
| å‰æ²¿æ£€æµ‹ | <100ms | >200ms |
| è·¯å¾„è§„åˆ’ | <500ms | >1000ms |
| DWAè®¡ç®— | <100ms | >200ms |

## ç¡¬ä»¶è°ƒè¯•

### STM32ç«¯è°ƒè¯•
```c
// 1. ä½¿ç”¨printfè°ƒè¯•ï¼ˆéœ€è¦é…ç½®UARTé‡å®šå‘ï¼‰
printf("DEBUG: left_rps=%.2f, right_rps=%.2f\n", left_rps, right_rps);

// 2. ä½¿ç”¨æ–­ç‚¹è°ƒè¯•ï¼ˆSTM32CubeIDEï¼‰
// - è®¾ç½®æ–­ç‚¹
// - æŸ¥çœ‹å˜é‡å€¼
// - å•æ­¥æ‰§è¡Œ

// 3. ç›‘è§†å…³é”®å˜é‡
// - åœ¨STM32CubeIDEä¸­æ·»åŠ åˆ°"Expressions"çª—å£
volatile float debug_left_rps = 0;
volatile float debug_right_rps = 0;
```

### ç¤ºæ³¢å™¨/é€»è¾‘åˆ†æä»ªï¼ˆå¯é€‰ï¼‰
- æŸ¥çœ‹ç¼–ç å™¨è„‰å†²ä¿¡å·
- éªŒè¯PWMé¢‘ç‡å’Œå ç©ºæ¯”
- åˆ†æI2C/SPIæ—¶åº

## æµ‹è¯•é©±åŠ¨è°ƒè¯•

### éš”ç¦»é—®é¢˜
```python
# åˆ›å»ºæœ€å°å¤ç°æ¡ˆä¾‹
def test_minimal_reproduction():
    """æœ€å°åŒ–é—®é¢˜å¤ç°"""
    from src.slam.occupancy_map import OccupancyGridMap
    
    map = OccupancyGridMap(10, 10, 0.1)
    # ä»…æµ‹è¯•æœ‰é—®é¢˜çš„åŠŸèƒ½
    map.update_cell(5, 5, 0.9)
    
    assert map.get_cell(5, 5) == 0.9
```

## ç´§æ€¥åœæ­¢

### è¿œç¨‹åœæ­¢æœºå™¨äºº
```python
# scripts/emergency_stop.py
from src.communication.robot_comm import RobotComm

with RobotComm(port='COM5') as comm:
    comm.send_speed_command(0, 0)  # ç«‹å³åœæ­¢
    print("âœ… ç´§æ€¥åœæ­¢æˆåŠŸ")
```

```bash
# å¿«æ·é”®è¿è¡Œ
python scripts/emergency_stop.py
```

## æ•…éšœæ—¥å¿—æ”¶é›†

### è‡ªåŠ¨ä¿å­˜æ•…éšœæ—¥å¿—
```python
import traceback
from datetime import datetime

def save_error_log(error, context):
    """ä¿å­˜é”™è¯¯æ—¥å¿—åˆ°æ–‡ä»¶"""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"data/logs/error_{timestamp}.log"
    
    with open(filename, 'w') as f:
        f.write(f"æ—¶é—´: {datetime.now()}\n")
        f.write(f"é”™è¯¯ç±»å‹: {type(error).__name__}\n")
        f.write(f"é”™è¯¯ä¿¡æ¯: {str(error)}\n")
        f.write(f"ä¸Šä¸‹æ–‡: {context}\n\n")
        f.write("å †æ ˆè·Ÿè¸ª:\n")
        f.write(traceback.format_exc())
    
    print(f"é”™è¯¯æ—¥å¿—å·²ä¿å­˜: {filename}")
```

## å‚è€ƒæ–‡æ¡£

- å®Œæ•´ç³»ç»Ÿæµ‹è¯•æŒ‡å—: [xxq_host/doc/å®Œæ•´ç³»ç»Ÿæµ‹è¯•æŒ‡å—.md](mdc:xxq_host/doc/å®Œæ•´ç³»ç»Ÿæµ‹è¯•æŒ‡å—.md)
- é€šä¿¡åè®®: [xxq_host/doc/ç¡¬ä»¶é€šä¿¡åè®®è¯¦ç»†è¯´æ˜.md](mdc:xxq_host/doc/ç¡¬ä»¶é€šä¿¡åè®®è¯¦ç»†è¯´æ˜.md)
- æµ‹è¯•è„šæœ¬: [scripts/](mdc:xxq_host/scripts/)
