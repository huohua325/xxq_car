# xxq_host ä»£ç æ‰§è¡Œæµç¨‹è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ä» `python main_exploration.py` å¯åŠ¨åˆ°æ•´ä¸ªç³»ç»Ÿè¿è¡Œçš„å®Œæ•´è°ƒç”¨é“¾ã€‚

---

## ğŸ“‹ ç›®å½•

1. [å¯åŠ¨é˜¶æ®µ](#1-å¯åŠ¨é˜¶æ®µ)
2. [é€šä¿¡æ¨¡å—å·¥ä½œæµç¨‹](#2-é€šä¿¡æ¨¡å—å·¥ä½œæµç¨‹)
3. [å›è°ƒæœºåˆ¶è¯¦è§£](#3-å›è°ƒæœºåˆ¶è¯¦è§£)
4. [æ§åˆ¶å™¨å·¥ä½œæµç¨‹](#4-æ§åˆ¶å™¨å·¥ä½œæµç¨‹)
5. [å®Œæ•´è°ƒç”¨é“¾](#5-å®Œæ•´è°ƒç”¨é“¾)
6. [å…³é”®é—®é¢˜ç­”ç–‘](#6-å…³é”®é—®é¢˜ç­”ç–‘)

---

## 1. å¯åŠ¨é˜¶æ®µ

### 1.1 å‘½ä»¤è¡Œå¯åŠ¨

```bash
python main_exploration.py
```

### 1.2 main() å‡½æ•°æ‰§è¡Œæµç¨‹

```python
# æ–‡ä»¶: xxq_host/main_exploration.py

def main():
    # ===== æ­¥éª¤1: åˆå§‹åŒ–é€šä¿¡å¯¹è±¡ =====
    comm = RobotComm(port=config.SERIAL_PORT, baudrate=config.BAUDRATE)
    # ä½œç”¨ï¼šåˆ›å»ºé€šä¿¡å¯¹è±¡ï¼Œä½†æ­¤æ—¶å°šæœªè¿æ¥ä¸²å£
    
    # ===== æ­¥éª¤2: å¯åŠ¨ä¸²å£é€šä¿¡ =====
    if not comm.start():
        sys.exit(1)
    # ä½œç”¨ï¼š
    #   1. æ‰“å¼€ä¸²å£è¿æ¥ï¼ˆserial.Serial()ï¼‰
    #   2. åˆ›å»ºå¹¶å¯åŠ¨ç‹¬ç«‹çš„æ¥æ”¶çº¿ç¨‹ï¼ˆ_receive_loopï¼‰
    #   3. çº¿ç¨‹å¼€å§‹ç›‘å¬ä¸²å£æ•°æ®
    
    # ===== æ­¥éª¤3: ç­‰å¾…åˆå§‹æ•°æ® =====
    time.sleep(1.0)
    # ä½œç”¨ï¼šç­‰å¾…STM32å‘é€åˆå§‹çš„POSEã€MPUã€ODOæ•°æ®
    
    # ===== æ­¥éª¤4: åˆ›å»ºæ§åˆ¶å™¨ =====
    controller = RobotController(comm=comm, enable_visualization=False)
    # âš ï¸ å…³é”®ï¼šåœ¨è¿™é‡Œä¼šè‡ªåŠ¨ç»‘å®šå›è°ƒå‡½æ•°ï¼ˆè§ä¸‹æ–‡ï¼‰
    
    # ===== æ­¥éª¤5: è¿è¡Œæ¢ç´¢ =====
    controller.run_exploration(max_steps=500, save_map=True)
    # ä½œç”¨ï¼šå¯åŠ¨è‡ªä¸»æ¢ç´¢ä¸»å¾ªç¯ï¼ˆè¯¦è§ç¬¬4èŠ‚ï¼‰
```

**æ—¶åºå›¾ï¼š**

```
ç”¨æˆ·                main()              RobotComm           STM32
 |                    |                     |                 |
 |--python main.py--->|                     |                 |
 |                    |--RobotComm()------->|                 |
 |                    |                     |                 |
 |                    |--comm.start()------>|                 |
 |                    |                     |--æ‰“å¼€ä¸²å£------->|
 |                    |                     |--å¯åŠ¨æ¥æ”¶çº¿ç¨‹--->|
 |                    |                     |                 |
 |                    |<------------------âœ…è¿”å›True---------|
 |                    |                     |                 |
 |                    |--sleep(1.0)-------->|                 |
 |                    |                     |<====æ¥æ”¶æ•°æ®====|  (åå°çº¿ç¨‹æŒç»­è¿è¡Œ)
 |                    |                     |   POSE,ODO,MPU  |
 |                    |                     |                 |
 |                    |--RobotController()->|                 |
 |                    |   (ç»‘å®šå›è°ƒ)        |                 |
 |                    |                     |                 |
 |                    |--run_exploration()->|                 |
```

---

## 2. é€šä¿¡æ¨¡å—å·¥ä½œæµç¨‹

### 2.1 RobotComm çš„æ ¸å¿ƒæœºåˆ¶

```python
# æ–‡ä»¶: xxq_host/src/communication/robot_comm.py

class RobotComm:
    def __init__(self, port, baudrate):
        # åˆå§‹åŒ–æ•°æ®ç¼“å­˜
        self.latest_lidar = None
        self.latest_mpu = None
        self.latest_odom = None
        self.latest_pose = None
        
        # åˆå§‹åŒ–å›è°ƒå‡½æ•°ï¼ˆæ­¤æ—¶éƒ½æ˜¯Noneï¼‰
        self.on_lidar_update = None
        self.on_mpu_update = None
        self.on_odom_update = None
        self.on_pose_update = None  # âš ï¸ é‡ç‚¹ï¼šè¿™ä¸ªä¼šè¢«Controllerè®¾ç½®
    
    def start(self):
        # 1. æ‰“å¼€ä¸²å£
        self.serial = serial.Serial(self.port, self.baudrate)
        
        # 2. å¯åŠ¨ç‹¬ç«‹çº¿ç¨‹
        self.running = True
        self.receive_thread = threading.Thread(target=self._receive_loop, daemon=True)
        self.receive_thread.start()  # âš ï¸ çº¿ç¨‹ä»è¿™é‡Œå¼€å§‹è¿è¡Œ
        
        return True
```

### 2.2 æ¥æ”¶çº¿ç¨‹å·¥ä½œæµç¨‹

```python
def _receive_loop(self):
    """è¿™ä¸ªå‡½æ•°åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æŒç»­è¿è¡Œ"""
    buffer = ""
    
    while self.running:  # âš ï¸ åªè¦ç¨‹åºä¸é€€å‡ºï¼Œå°±ä¸€ç›´å¾ªç¯
        # æ­¥éª¤1: ä»ä¸²å£è¯»å–æ•°æ®
        if self.serial.in_waiting:
            data = self.serial.read(self.serial.in_waiting)
            decoded = data.decode('utf-8')
            buffer += decoded
            
            # æ­¥éª¤2: æŒ‰è¡Œæ‹†åˆ†æ•°æ®
            while '\n' in buffer:
                line, buffer = buffer.split('\n', 1)
                self._parse_line(line.strip())  # âš ï¸ è§£ææ¯ä¸€è¡Œ
        else:
            time.sleep(0.001)  # æ²¡æ•°æ®æ—¶ä¼‘çœ 1ms
```

### 2.3 æ•°æ®è§£ææµç¨‹

```python
def _parse_line(self, line: str):
    """è§£æSTM32å‘æ¥çš„ä¸€è¡Œæ•°æ®"""
    
    # ç¤ºä¾‹: "POSE,12345,0.150,-0.320,45.2"
    #         ^^^^  ^^^^^  ^^^^^  ^^^^^^ ^^^^
    #         ç±»å‹  æ—¶é—´æˆ³   x      y     theta
    
    if not line:
        return
    
    # åˆ¤æ–­æ•°æ®ç±»å‹
    if line.startswith('{'):
        # JSONæ ¼å¼ -> é›·è¾¾æ•°æ®
        self._parse_lidar_json(line)
    elif ',' in line:
        # CSVæ ¼å¼ -> MPU/ODO/POSE
        self._parse_csv(line)

def _parse_csv(self, line: str):
    parts = line.split(',')
    data_type = parts[0]
    
    # âš ï¸ å…³é”®ï¼šè§£æPOSEæ•°æ®
    if data_type == 'POSE' and len(parts) == 5:
        # æ­¥éª¤1: åˆ›å»ºPoseDataå¯¹è±¡
        self.latest_pose = PoseData(
            timestamp=int(parts[1]),
            x=float(parts[2]),        # å•ä½ï¼šç±³
            y=float(parts[3]),        # å•ä½ï¼šç±³
            theta=float(parts[4])     # å•ä½ï¼šåº¦
        )
        
        # æ­¥éª¤2: è§¦å‘å›è°ƒå‡½æ•°ï¼ˆå¦‚æœå·²è®¾ç½®ï¼‰
        if self.on_pose_update:
            self.on_pose_update(self.latest_pose)  # âš ï¸ è¿™é‡Œä¼šè°ƒç”¨Controllerçš„å›è°ƒ
```

**æ•°æ®æµç¤ºæ„å›¾ï¼š**

```
STM32å›ºä»¶                æ¥æ”¶çº¿ç¨‹                  å›è°ƒå‡½æ•°
   |                       |                         |
   |--POSE,123,0.1,0.2,45->|                         |
   |                       |                         |
   |                    è§£ææ•°æ®                     |
   |                       |                         |
   |                    åˆ›å»ºPoseData                 |
   |                  latest_pose = ...              |
   |                       |                         |
   |                  æ£€æŸ¥on_pose_update?            |
   |                       |                         |
   |                    âœ… å·²è®¾ç½®                     |
   |                       |                         |
   |                       |--on_pose_update(data)-->|
   |                       |                         |
   |                       |        Controller._on_hardware_pose_update()
   |                       |        æ›´æ–°æœºå™¨äººä½å§¿
```

---

## 3. å›è°ƒæœºåˆ¶è¯¦è§£

### 3.1 å›è°ƒå‡½æ•°çš„ç»‘å®š

```python
# æ–‡ä»¶: xxq_host/src/navigation/controller.py

class RobotController:
    def __init__(self, comm=None, ...):
        self.comm = comm
        
        # âš ï¸ å…³é”®ï¼šåœ¨åˆå§‹åŒ–æ—¶ç»‘å®šå›è°ƒå‡½æ•°
        if self.comm:
            # å°†è‡ªå·±çš„æ–¹æ³•è®¾ç½®ä¸ºé€šä¿¡å¯¹è±¡çš„å›è°ƒ
            self.comm.on_pose_update = self._on_hardware_pose_update
            self.comm.on_lidar_update = self._on_hardware_lidar_update
            # ç°åœ¨å½“RobotCommæ”¶åˆ°æ•°æ®æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è¿™äº›æ–¹æ³•
```

**ç»‘å®šè¿‡ç¨‹ç¤ºæ„å›¾ï¼š**

```
main_exploration.py           RobotController              RobotComm
      |                              |                         |
      |--controller=RobotController(comm)-->                   |
      |                              |                         |
      |                          __init__()                    |
      |                              |                         |
      |                        if self.comm:                   |
      |                              |                         |
      |                     self.comm.on_pose_update = self._on_hardware_pose_update
      |                              |                         |
      |                              |----è®¾ç½®å›è°ƒå‡½æ•°æŒ‡é’ˆ----->| on_pose_update
      |                              |                         | = Controller._on_hardware_pose_update
      |                              |                         |
      |                         âœ… ç»‘å®šå®Œæˆ                     |
```

### 3.2 å›è°ƒå‡½æ•°çš„æ‰§è¡Œ

```python
def _on_hardware_pose_update(self, pose_data):
    """æ¥æ”¶STM32çš„POSEæ•°æ®ï¼ˆç¡¬ä»¶ä½å§¿ï¼‰
    
    âš ï¸ é‡è¦ï¼šè¿™ä¸ªå‡½æ•°åœ¨RobotCommçš„æ¥æ”¶çº¿ç¨‹ä¸­è¢«è°ƒç”¨
    
    Args:
        pose_data: PoseDataå¯¹è±¡ï¼ŒåŒ…å«x, y, theta
    """
    # æ­¥éª¤1: ä¿å­˜ä¸Šæ¬¡ä½å§¿ï¼ˆç”¨äºè®¡ç®—ä½ç§»ï¼‰
    self.last_pose = self.robot_pose.copy()
    
    # æ­¥éª¤2: æ›´æ–°å½“å‰ä½å§¿
    self.robot_pose[0] = pose_data.x           # xåæ ‡ï¼ˆç±³ï¼‰
    self.robot_pose[1] = pose_data.y           # yåæ ‡ï¼ˆç±³ï¼‰
    self.robot_pose[2] = np.deg2rad(pose_data.theta)  # è½¬ä¸ºå¼§åº¦
    
    # æ­¥éª¤3: è®¡ç®—ç§»åŠ¨è·ç¦»
    displacement = np.hypot(
        self.robot_pose[0] - self.last_pose[0],
        self.robot_pose[1] - self.last_pose[1]
    )
    self.total_distance += displacement
    
    # æ­¥éª¤4: å®šæœŸæ‰“å°æ—¥å¿—
    if self.exploration_steps % 50 == 0:
        print(f"[ç¡¬ä»¶POSE] x={pose_data.x:.3f}m, y={pose_data.y:.3f}m, Î¸={pose_data.theta:.1f}Â°")
```

**æ‰§è¡Œæ—¶åºå›¾ï¼š**

```
æ¥æ”¶çº¿ç¨‹                  å›è°ƒå‡½æ•°                  ControllerçŠ¶æ€
   |                         |                         |
   |--æ”¶åˆ°POSEæ•°æ®----------->|                         |
   |                         |                         |
   |--_parse_csv()---------->|                         |
   |  åˆ›å»ºPoseData           |                         |
   |                         |                         |
   |--è°ƒç”¨on_pose_update---->|                         |
   |                         |                         |
   |                 _on_hardware_pose_update()        |
   |                         |                         |
   |                         |--self.robot_pose[0]=x-->| robot_pose[0] = 0.15
   |                         |--self.robot_pose[1]=y-->| robot_pose[1] = -0.32
   |                         |--self.robot_pose[2]=Î¸-->| robot_pose[2] = 0.785
   |                         |                         |
   |                         |--total_distance += ..-->| total_distance = 1.23
   |                         |                         |
   |                         |<------------------------âœ…ä½å§¿å·²æ›´æ–°
   |                         |                         |
   |--ç»§ç»­æ¥æ”¶ä¸‹ä¸€ä¸ªæ•°æ®----->|                         |
```

**âš ï¸ å…³é”®ç‚¹ï¼š**
- `_on_hardware_pose_update()` **ä¸æ˜¯ä¸»åŠ¨è°ƒç”¨çš„**ï¼Œè€Œæ˜¯è¢« `RobotComm` çš„æ¥æ”¶çº¿ç¨‹**è‡ªåŠ¨è§¦å‘**
- æ¯æ¬¡STM32å‘é€ `POSE,xxx,xxx,xxx` æ•°æ®æ—¶ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«è°ƒç”¨ä¸€æ¬¡
- è¿™æ˜¯ä¸€ä¸ª**å¼‚æ­¥æœºåˆ¶**ï¼Œè¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­

---

## 4. æ§åˆ¶å™¨å·¥ä½œæµç¨‹

### 4.1 æ¢ç´¢ä¸»å¾ªç¯

```python
# æ–‡ä»¶: xxq_host/src/navigation/controller.py

def run_exploration(self, max_steps=500, save_map=True):
    """è¿è¡Œè‡ªä¸»æ¢ç´¢
    
    Args:
        max_steps: æœ€å¤§æ¢ç´¢æ­¥æ•°ï¼ˆé»˜è®¤500ï¼Œçº¦50ç§’ï¼‰
        save_map: æ˜¯å¦ä¿å­˜åœ°å›¾
    """
    print("\n" + "="*70)
    print(" å¼€å§‹è‡ªä¸»æ¢ç´¢")
    print("="*70)
    
    # ===== åˆå§‹åŒ– =====
    self.start_time = time.time()
    self.exploration_steps = 0
    self.state = RobotState.EXPLORING
    
    # ===== å¯åŠ¨å‰è¯·æ±‚é›·è¾¾æ‰«æ =====
    if self.comm:
        self.comm.request_lidar_scan()  # å‘é€ 'A' å‘½ä»¤ç»™STM32
        time.sleep(0.5)  # ç­‰å¾…é›·è¾¾æ•°æ®
    
    # ===== ä¸»å¾ªç¯ =====
    while self.exploration_steps < max_steps:
        # æ­¥éª¤1: æ‰§è¡Œä¸€æ­¥æ§åˆ¶ï¼ˆè§4.2èŠ‚ï¼‰
        should_continue = self._control_step()
        
        if not should_continue:
            print("[æ¢ç´¢] æ— æ›´å¤šå‰æ²¿ç‚¹ï¼Œæ¢ç´¢å®Œæˆ")
            break
        
        self.exploration_steps += 1
        
        # æ­¥éª¤2: å®šæœŸæ‰“å°ç»Ÿè®¡ä¿¡æ¯
        if self.exploration_steps % 50 == 0:
            self._print_statistics()
    
    # ===== ç»“æŸæ¸…ç† =====
    if self.comm:
        self.comm.stop_robot()
    
    if save_map:
        self._save_map()
    
    return self.state == RobotState.COMPLETED
```

### 4.2 å•æ­¥æ§åˆ¶æµç¨‹

```python
def _control_step(self) -> bool:
    """æ‰§è¡Œä¸€æ­¥æ§åˆ¶ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰
    
    Returns:
        æ˜¯å¦åº”ç»§ç»­æ¢ç´¢
    """
    # ===== æ­¥éª¤1: æ£€æµ‹å‰æ²¿ç‚¹ =====
    frontiers = self.frontier_detector.detect_frontiers()
    
    if len(frontiers) == 0:
        # æ²¡æœ‰å‰æ²¿ç‚¹ -> æ¢ç´¢å®Œæˆ
        self.state = RobotState.COMPLETED
        return False
    
    # ===== æ­¥éª¤2: é€‰æ‹©ç›®æ ‡å‰æ²¿ç‚¹ =====
    if self.current_target is None:
        # æ ¹æ®ç­–ç•¥é€‰æ‹©ï¼ˆnearest/largest/information_gainï¼‰
        self.current_target = self.frontier_detector.select_best_frontier(
            frontiers,
            tuple(self.robot_pose),
            strategy=config.FRONTIER_SELECTION
        )
        
        # è§„åˆ’å…¨å±€è·¯å¾„ï¼ˆA*ç®—æ³•ï¼‰
        self.current_path = self.path_planner.plan(
            tuple(self.robot_pose[:2]),  # èµ·ç‚¹
            self.current_target           # ç»ˆç‚¹
        )
        
        if not self.current_path:
            # è·¯å¾„è§„åˆ’å¤±è´¥
            self.current_target = None
            return True
        
        self.path_index = 0
        self.state = RobotState.NAVIGATING
        print(f"[æ¢ç´¢] æ–°ç›®æ ‡: {self.current_target}, è·¯å¾„é•¿åº¦: {len(self.current_path)}")
    
    # ===== æ­¥éª¤3: æ²¿è·¯å¾„å¯¼èˆª =====
    if self.path_index < len(self.current_path):
        # è·å–å±€éƒ¨ç›®æ ‡ç‚¹ï¼ˆè·¯å¾„ä¸Šçš„ä¸‹ä¸€ä¸ªç‚¹ï¼‰
        local_goal = self.current_path[self.path_index]
        
        # æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å½“å‰è·¯å¾„ç‚¹
        distance_to_goal = np.hypot(
            local_goal[0] - self.robot_pose[0],
            local_goal[1] - self.robot_pose[1]
        )
        
        if distance_to_goal < 0.1:  # åˆ°è¾¾é˜ˆå€¼ï¼š0.1ç±³
            self.path_index += 1
            if self.path_index >= len(self.current_path):
                # åˆ°è¾¾æœ€ç»ˆç›®æ ‡
                print("[æ¢ç´¢] åˆ°è¾¾ç›®æ ‡å‰æ²¿ç‚¹")
                self.current_target = None
                self.state = RobotState.EXPLORING
                return True
        
        # ===== æ­¥éª¤4: DWAå±€éƒ¨é¿éšœ =====
        robot_state = tuple(self.robot_pose + self.robot_velocity)
        obstacles = []  # ç®€åŒ–ï¼šæš‚ä¸ä½¿ç”¨éšœç¢ç‰©åˆ—è¡¨
        
        # DWAè§„åˆ’é€Ÿåº¦
        v, omega = self.dwa.plan(robot_state, local_goal, obstacles)
        
        # ===== æ­¥éª¤5: å‘é€é€Ÿåº¦æŒ‡ä»¤åˆ°ç¡¬ä»¶ =====
        self._update_robot_state(v, omega, dt=0.1)
        
        # æ§åˆ¶é¢‘ç‡é™åˆ¶
        time.sleep(0.1)  # 10Hz
        
        # ===== æ­¥éª¤6: å®šæœŸè¯·æ±‚é›·è¾¾æ‰«æ =====
        if self.comm and self.exploration_steps % 10 == 0:
            self.comm.request_lidar_scan()
    
    # ===== æ­¥éª¤7: å¡ä½æ£€æµ‹ =====
    displacement = np.hypot(
        self.robot_pose[0] - self.last_pose[0],
        self.robot_pose[1] - self.last_pose[1]
    )
    
    if displacement < 0.01:  # ç§»åŠ¨å°äº1cm
        self.stuck_counter += 1
        if self.stuck_counter > self.stuck_threshold:
            self._handle_stuck()  # åé€€+è½¬å‘
    else:
        self.stuck_counter = 0
    
    # ===== æ­¥éª¤8: æ›´æ–°å¯è§†åŒ– =====
    if self.enable_visualization and self.visualizer:
        self._update_visualization(frontiers)
    
    return True
```

### 4.3 é€Ÿåº¦æŒ‡ä»¤å‘é€

```python
def _update_robot_state(self, v: float, omega: float, dt: float = 0.1):
    """å‘é€é€Ÿåº¦æŒ‡ä»¤åˆ°æœºå™¨äºº
    
    âš ï¸ æ³¨æ„ï¼šè¿™ä¸ªå‡½æ•°åªå‘é€æŒ‡ä»¤ï¼Œä¸æ›´æ–°ä½å§¿
    ä½å§¿æ›´æ–°ç”± _on_hardware_pose_update() è´Ÿè´£
    
    Args:
        v: çº¿é€Ÿåº¦ (m/s)
        omega: è§’é€Ÿåº¦ (rad/s)
        dt: æ—¶é—´æ­¥é•¿ï¼ˆä¿ç•™ï¼Œå®é™…æœªä½¿ç”¨ï¼‰
    """
    # æ­¥éª¤1: è®°å½•å½“å‰é€Ÿåº¦
    self.robot_velocity = [v, omega]
    
    if self.comm:
        # æ­¥éª¤2: å·®åˆ†é©±åŠ¨è¿åŠ¨å­¦è½¬æ¢
        wheel_base = config.WHEEL_BASE      # è½®è·ï¼ˆç±³ï¼‰
        wheel_radius = config.WHEEL_RADIUS  # è½®åŠå¾„ï¼ˆç±³ï¼‰
        
        # å·¦å³è½®çº¿é€Ÿåº¦
        v_left = v - omega * wheel_base / 2.0
        v_right = v + omega * wheel_base / 2.0
        
        # è½¬æ¢ä¸ºè½®é€Ÿï¼ˆRPS = è½¬/ç§’ï¼‰
        left_rps = v_left / (2.0 * np.pi * wheel_radius)
        right_rps = v_right / (2.0 * np.pi * wheel_radius)
        
        # æ­¥éª¤3: å‘é€é€Ÿåº¦æŒ‡ä»¤
        self.comm.send_speed_command(left_rps, right_rps)
        # è¿™ä¼šå‘é€: "SPD,0.85,1.23\n" åˆ°STM32
    else:
        print("[è­¦å‘Š] æ— é€šä¿¡å¯¹è±¡ï¼Œæ— æ³•å‘é€é€Ÿåº¦æŒ‡ä»¤")
    
    # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œä¸æ›´æ–°self.robot_pose
    # ä½å§¿ç”± _on_hardware_pose_update() ä»ç¡¬ä»¶æ•°æ®æ›´æ–°
```

---

## 5. å®Œæ•´è°ƒç”¨é“¾

### 5.1 å¯åŠ¨åˆ°è¿è¡Œçš„å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·æ‰§è¡Œ: python main_exploration.py
   â””â”€> main()
       â”‚
       â”œâ”€> [æ­¥éª¤1] comm = RobotComm(...)
       â”‚   â””â”€> åˆ›å»ºé€šä¿¡å¯¹è±¡ï¼ˆå°šæœªè¿æ¥ï¼‰
       â”‚
       â”œâ”€> [æ­¥éª¤2] comm.start()
       â”‚   â”œâ”€> æ‰“å¼€ä¸²å£
       â”‚   â””â”€> å¯åŠ¨æ¥æ”¶çº¿ç¨‹
       â”‚       â””â”€> _receive_loop() å¼€å§‹è¿è¡Œï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰
       â”‚           â””â”€> æŒç»­ç›‘å¬ä¸²å£
       â”‚               â””â”€> æ”¶åˆ°æ•°æ® -> _parse_line()
       â”‚                   â””â”€> _parse_csv()
       â”‚                       â””â”€> åˆ›å»ºPoseData
       â”‚                           â””â”€> è°ƒç”¨ on_pose_update(pose_data)
       â”‚                               â””â”€> Controller._on_hardware_pose_update()
       â”‚                                   â””â”€> æ›´æ–° self.robot_pose
       â”‚
       â”œâ”€> [æ­¥éª¤3] time.sleep(1.0)
       â”‚   â””â”€> ç­‰å¾…åˆå§‹æ•°æ®ï¼ˆåœ¨æ­¤æœŸé—´æ¥æ”¶çº¿ç¨‹å·²åœ¨å·¥ä½œï¼‰
       â”‚
       â”œâ”€> [æ­¥éª¤4] controller = RobotController(comm)
       â”‚   â””â”€> RobotController.__init__()
       â”‚       â”œâ”€> åˆ›å»ºåœ°å›¾ OccupancyGridMap
       â”‚       â”œâ”€> åˆ›å»ºå‰æ²¿æ£€æµ‹å™¨ FrontierDetector
       â”‚       â”œâ”€> åˆ›å»ºè·¯å¾„è§„åˆ’å™¨ PathPlanner
       â”‚       â”œâ”€> åˆ›å»ºDWAé¿éšœå™¨
       â”‚       â””â”€> âš ï¸ ç»‘å®šå›è°ƒ:
       â”‚           â””â”€> self.comm.on_pose_update = self._on_hardware_pose_update
       â”‚           â””â”€> self.comm.on_lidar_update = self._on_hardware_lidar_update
       â”‚
       â””â”€> [æ­¥éª¤5] controller.run_exploration()
           â””â”€> while exploration_steps < max_steps:
               â””â”€> _control_step()
                   â”œâ”€> æ£€æµ‹å‰æ²¿ç‚¹
                   â”œâ”€> é€‰æ‹©ç›®æ ‡ + A*è§„åˆ’
                   â”œâ”€> DWAè§„åˆ’é€Ÿåº¦ (v, omega)
                   â”œâ”€> _update_robot_state(v, omega)
                   â”‚   â””â”€> è½¬æ¢ä¸ºè½®é€Ÿ
                   â”‚       â””â”€> comm.send_speed_command(L, R)
                   â”‚           â””â”€> å‘é€ "SPD,L,R\n" åˆ°STM32
                   â”‚
                   â””â”€> time.sleep(0.1)  # 10Hzæ§åˆ¶é¢‘ç‡
```

### 5.2 æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STM32å›ºä»¶                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ä½å§¿ä¼°è®¡ â”‚  â”‚ ç¼–ç å™¨   â”‚  â”‚ MPU6500  â”‚  â”‚ é›·è¾¾     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚             â”‚              â”‚              â”‚            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                     â”‚                                           â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                                     â”‚
â”‚               â”‚ UARTå‘é€  â”‚                                     â”‚
â”‚               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ ä¸²å£
                      â”‚ "POSE,123,0.15,-0.32,45.2\n"
                      â”‚ "ODO,124,1.2,1.3,4567,4823\n"
                      â”‚ "{'type':'LIDAR',...}\n"
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    xxq_host (Python)                           â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          RobotComm (ç‹¬ç«‹æ¥æ”¶çº¿ç¨‹)                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚    â”‚
â”‚  â”‚  â”‚_receive_loopâ”‚ æŒç»­è¿è¡Œ                             â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â”‚    â”‚
â”‚  â”‚         â”‚                                             â”‚    â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚    â”‚
â”‚  â”‚    â”‚_parse   â”‚â”€â”€â”€â”€>â”‚latest_pose â”‚                    â”‚    â”‚
â”‚  â”‚    â”‚_line    â”‚     â”‚latest_lidarâ”‚                    â”‚    â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â”‚latest_odom â”‚                    â”‚    â”‚
â”‚  â”‚         â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚    â”‚
â”‚  â”‚         â”‚                                             â”‚    â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚    â”‚
â”‚  â”‚    â”‚è§¦å‘å›è°ƒå‡½æ•°      â”‚                               â”‚    â”‚
â”‚  â”‚    â”‚on_pose_update() â”‚                               â”‚    â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                                                   â”‚
â”‚            â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              RobotController                            â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚_on_hardware_pose_update(pose_data) â”‚               â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€> self.robot_pose[0] = pose.x   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€> self.robot_pose[1] = pose.y   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€> self.robot_pose[2] = pose.Î¸   â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ run_exploration() ä¸»å¾ªç¯           â”‚               â”‚   â”‚
â”‚  â”‚  â”‚  while steps < max_steps:          â”‚               â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€> æ£€æµ‹å‰æ²¿                    â”‚               â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€> A*è§„åˆ’è·¯å¾„                  â”‚               â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€> DWAè§„åˆ’é€Ÿåº¦                 â”‚               â”‚   â”‚
â”‚  â”‚  â”‚    â””â”€> å‘é€é€Ÿåº¦æŒ‡ä»¤                â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚               â”‚                                        â”‚   â”‚
â”‚  â”‚               â–¼                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚   â”‚
â”‚  â”‚  â”‚_update_robot_state(v, Ï‰)   â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€> è®¡ç®—å·¦å³è½®é€Ÿ           â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€> comm.send_speed_cmd()  â”‚                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚                                            â”‚
â”‚                  â”‚ "SPD,0.85,1.23\n"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ ä¸²å£
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STM32å›ºä»¶                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ UARTæ¥æ”¶   â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚        â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚Parse_PC_Command  â”‚                                         â”‚
â”‚  â”‚  "SPD,0.85,1.23" â”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚        â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚DiffDrive_SetWheelSpeeds()  â”‚                              â”‚
â”‚  â”‚  â”œâ”€> target_left = 0.85    â”‚                              â”‚
â”‚  â”‚  â””â”€> target_right = 1.23   â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚        â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚ PIDæ§åˆ¶å¾ªç¯ (20Hz)     â”‚                                  â”‚
â”‚  â”‚  â”œâ”€> Motor_PID_Control â”‚                                  â”‚
â”‚  â”‚  â””â”€> PWMè¾“å‡º           â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. å…³é”®é—®é¢˜ç­”ç–‘

### Q1: `_on_hardware_pose_update()` æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿ

**ç­”ï¼š** é€šè¿‡å›è°ƒæœºåˆ¶ï¼Œåœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­è‡ªåŠ¨è§¦å‘ã€‚

```python
# 1. Controlleråˆå§‹åŒ–æ—¶ç»‘å®š
controller = RobotController(comm)
  â””â”€> self.comm.on_pose_update = self._on_hardware_pose_update

# 2. RobotCommæ¥æ”¶åˆ°æ•°æ®æ—¶è§¦å‘
RobotComm._receive_loop()  # ç‹¬ç«‹çº¿ç¨‹
  â””â”€> _parse_csv("POSE,123,0.15,-0.32,45.2")
      â””â”€> self.latest_pose = PoseData(...)
          â””â”€> if self.on_pose_update:  # æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†å›è°ƒ
                  self.on_pose_update(self.latest_pose)  # è°ƒç”¨Controllerçš„æ–¹æ³•
                    â””â”€> Controller._on_hardware_pose_update(pose_data)
```

**âš ï¸ å…³é”®ç‚¹ï¼š**
- `_on_hardware_pose_update()` è¿è¡Œåœ¨ **RobotCommçš„æ¥æ”¶çº¿ç¨‹** ä¸­
- ä¸æ˜¯ä¸»çº¿ç¨‹è°ƒç”¨çš„ï¼Œæ˜¯å¼‚æ­¥è§¦å‘çš„
- æ¯æ¬¡STM32å‘é€POSEæ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°å°±æ‰§è¡Œä¸€æ¬¡

---

### Q2: ä½å§¿æ›´æ–°å’Œæ§åˆ¶å¾ªç¯æ˜¯å¦‚ä½•åŒæ­¥çš„ï¼Ÿ

**ç­”ï¼š** å®ƒä»¬æ˜¯**å¼‚æ­¥çš„**ï¼Œé€šè¿‡å…±äº«å˜é‡ `self.robot_pose` é€šä¿¡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥æ”¶çº¿ç¨‹ï¼ˆåå°ï¼‰    â”‚          â”‚  ä¸»çº¿ç¨‹ï¼ˆæ§åˆ¶å¾ªç¯ï¼‰  â”‚
â”‚                      â”‚          â”‚                      â”‚
â”‚  while True:         â”‚          â”‚  while steps < max:  â”‚
â”‚    æ”¶åˆ°POSEæ•°æ®      â”‚          â”‚                      â”‚
â”‚    â†“                 â”‚          â”‚    è¯»å–robot_pose    â”‚
â”‚    è§£ææ•°æ®          â”‚          â”‚    â†“                 â”‚
â”‚    â†“                 â”‚          â”‚    è§„åˆ’è·¯å¾„          â”‚
â”‚    æ›´æ–°robot_pose â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚    â†“                 â”‚
â”‚    â†“                 â”‚ å…±äº«å˜é‡ â”‚    DWAè§„åˆ’           â”‚
â”‚    ç»§ç»­æ¥æ”¶...       â”‚          â”‚    â†“                 â”‚
â”‚                      â”‚          â”‚    å‘é€é€Ÿåº¦æŒ‡ä»¤      â”‚
â”‚                      â”‚          â”‚    â†“                 â”‚
â”‚                      â”‚          â”‚    sleep(0.1)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ æ³¨æ„ï¼š**
- ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œäº’ä¸é˜»å¡
- æ¥æ”¶çº¿ç¨‹æŒç»­æ›´æ–° `robot_pose`
- æ§åˆ¶å¾ªç¯å®šæœŸè¯»å– `robot_pose`
- é¢‘ç‡ä¸åŒï¼šæ¥æ”¶çº¿ç¨‹æ›´å¿«ï¼ˆ~50Hzï¼‰ï¼Œæ§åˆ¶å¾ªç¯è¾ƒæ…¢ï¼ˆ10Hzï¼‰

---

### Q3: ä¸ºä»€ä¹ˆ `_update_robot_state()` ä¸æ›´æ–°ä½å§¿ï¼Ÿ

**ç­”ï¼š** å› ä¸ºé‡‡ç”¨äº†**ç¡¬ä»¶æ¨¡å¼**ï¼Œä½å§¿ç”±STM32çš„EKFä¼°è®¡å™¨è®¡ç®—ã€‚

```python
# âŒ æ—§ç‰ˆæœ¬ï¼ˆä»¿çœŸæ¨¡å¼ï¼‰
def _update_robot_state(v, omega, dt):
    # ä½¿ç”¨è¿åŠ¨å­¦å…¬å¼æ¨¡æ‹Ÿä½å§¿å˜åŒ–
    self.robot_pose[0] += v * cos(theta) * dt
    self.robot_pose[1] += v * sin(theta) * dt
    self.robot_pose[2] += omega * dt

# âœ… æ–°ç‰ˆæœ¬ï¼ˆç¡¬ä»¶æ¨¡å¼ï¼‰
def _update_robot_state(v, omega, dt):
    # åªå‘é€é€Ÿåº¦æŒ‡ä»¤
    left_rps, right_rps = è½¬æ¢(v, omega)
    self.comm.send_speed_command(left_rps, right_rps)
    
    # ä½å§¿æ›´æ–°ç”± _on_hardware_pose_update() è´Ÿè´£
    # æ•°æ®æ¥è‡ªSTM32çš„EKFä¼°è®¡å™¨ï¼ˆèåˆç¼–ç å™¨+IMUï¼‰
```

**ä¼˜åŠ¿ï¼š**
- ä½¿ç”¨çœŸå®çš„ç¼–ç å™¨å’ŒIMUæ•°æ®
- EKFèåˆå¤šä¼ æ„Ÿå™¨ï¼Œæ›´å‡†ç¡®
- è€ƒè™‘äº†æ‰“æ»‘ã€æƒ¯æ€§ç­‰çœŸå®å› ç´ 

---

### Q4: å¦‚æœæˆ‘æƒ³ä¿®æ”¹ä»£ç ï¼Œåº”è¯¥å…³æ³¨å“ªäº›åœ°æ–¹ï¼Ÿ

**ç­”ï¼š** æ ¹æ®éœ€æ±‚ä¸åŒï¼š

#### ğŸ“Œ ä¿®æ”¹å¯¼èˆªç­–ç•¥
```python
# æ–‡ä»¶: xxq_host/src/navigation/controller.py

# 1. ä¿®æ”¹å‰æ²¿é€‰æ‹©ç­–ç•¥
self.current_target = self.frontier_detector.select_best_frontier(
    frontiers,
    tuple(self.robot_pose),
    strategy='information_gain'  # æ”¹ä¸ºä¿¡æ¯å¢ç›Šä¼˜å…ˆ
)

# 2. ä¿®æ”¹DWAå‚æ•°
dwa_config = DWAConfig(
    max_speed=1.5,         # æé«˜æœ€å¤§é€Ÿåº¦
    heading_weight=0.3,    # è°ƒæ•´æƒé‡
    ...
)
```

#### ğŸ“Œ ä¿®æ”¹ç¡¬ä»¶æ¥å£
```python
# æ–‡ä»¶: xxq_host/src/communication/robot_comm.py

# 1. ä¿®æ”¹æ•°æ®æ ¼å¼
def _parse_csv(self, line):
    # å¦‚æœSTM32æ”¹å˜äº†æ•°æ®æ ¼å¼ï¼Œåœ¨è¿™é‡Œä¿®æ”¹è§£æ

# 2. æ·»åŠ æ–°çš„æ•°æ®ç±»å‹
def _parse_new_data(self, line):
    # æ·»åŠ æ–°çš„ä¼ æ„Ÿå™¨æ•°æ®è§£æ
```

#### ğŸ“Œ ä¿®æ”¹æ§åˆ¶é¢‘ç‡
```python
# æ–‡ä»¶: xxq_host/config.py

CONTROL_LOOP_RATE = 20  # æ”¹ä¸º20Hz

# æ–‡ä»¶: xxq_host/src/navigation/controller.py
time.sleep(1.0 / config.CONTROL_LOOP_RATE)  # åŠ¨æ€è°ƒæ•´
```

#### ğŸ“Œ è°ƒè¯•æŠ€å·§
```python
# 1. æ·»åŠ æ—¥å¿—
print(f"[DEBUG] robot_pose = {self.robot_pose}")
print(f"[DEBUG] target = {self.current_target}")
print(f"[DEBUG] velocity = {v:.2f}, {omega:.2f}")

# 2. ä¿å­˜æ•°æ®
import json
with open('debug_data.json', 'w') as f:
    json.dump({
        'pose': self.robot_pose,
        'path': self.current_path,
        'velocity': self.robot_velocity
    }, f)

# 3. å¯è§†åŒ–
self.enable_visualization = True  # å¯ç”¨å¯è§†åŒ–
```

---

## 7. å¸¸è§é—®é¢˜æ’æŸ¥

### âŒ é—®é¢˜1: æ”¶ä¸åˆ°POSEæ•°æ®

**æ£€æŸ¥æ¸…å•ï¼š**
```python
# 1. æ£€æŸ¥STM32æ˜¯å¦å‘é€æ•°æ®
#    - æ‰“å¼€ä¸²å£ç›‘è§†å™¨
#    - åº”è¯¥çœ‹åˆ°: "POSE,123,0.00,0.00,0.00"

# 2. æ£€æŸ¥å›è°ƒæ˜¯å¦ç»‘å®š
if comm.on_pose_update is None:
    print("[é”™è¯¯] å›è°ƒæœªç»‘å®š")
else:
    print("[æ­£å¸¸] å›è°ƒå·²ç»‘å®š")

# 3. æ£€æŸ¥æ•°æ®æ ¼å¼
#    - å¿…é¡»æ˜¯: "POSE,timestamp,x,y,theta\n"
#    - é€—å·åˆ†éš”ï¼Œ5ä¸ªå­—æ®µ
#    - ä»¥æ¢è¡Œç¬¦ç»“æŸ
```

### âŒ é—®é¢˜2: æœºå™¨äººä¸åŠ¨

**æ£€æŸ¥æ¸…å•ï¼š**
```python
# 1. æ£€æŸ¥é€Ÿåº¦æŒ‡ä»¤æ˜¯å¦å‘é€
comm.send_speed_command(1.0, 1.0)
print("[æµ‹è¯•] å‘é€é€Ÿåº¦æŒ‡ä»¤")

# 2. æ£€æŸ¥STM32æ˜¯å¦æ”¶åˆ°
#    - åœ¨STM32çš„Parse_PC_Commandæ·»åŠ æ—¥å¿—
#    - åº”è¯¥æ‰“å°: "[PC-CMD] SPD: L=1.00 R=1.00"

# 3. æ£€æŸ¥PIDæ§åˆ¶æ˜¯å¦å¯ç”¨
#    - g_pid_control_enabled åº”è¯¥ä¸º 1
#    - g_motor_mode åº”è¯¥ä¸º MOTOR_MODE_PID_CONTROL
```

### âŒ é—®é¢˜3: ä½å§¿ä¸æ›´æ–°

**æ£€æŸ¥æ¸…å•ï¼š**
```python
# 1. æ£€æŸ¥ç¼–ç å™¨æ˜¯å¦å·¥ä½œ
#    - æŸ¥çœ‹ODOæ•°æ®: left_count, right_countåº”è¯¥å˜åŒ–

# 2. æ£€æŸ¥EKFä¼°è®¡å™¨
#    - åœ¨pose_estimator.cæ·»åŠ æ—¥å¿—
#    - ç¡®è®¤UpdateOdometryè¢«è°ƒç”¨

# 3. æ£€æŸ¥å›è°ƒå‡½æ•°
def _on_hardware_pose_update(self, pose_data):
    print(f"[å›è°ƒ] æ”¶åˆ°ä½å§¿: {pose_data.x}, {pose_data.y}, {pose_data.theta}")
    # åº”è¯¥æ¯20msæ‰“å°ä¸€æ¬¡ï¼ˆ50Hzï¼‰
```

---

## 8. æ€»ç»“

### æ ¸å¿ƒæ‰§è¡Œæµç¨‹

```
å¯åŠ¨ â†’ åˆ›å»ºé€šä¿¡å¯¹è±¡ â†’ å¯åŠ¨æ¥æ”¶çº¿ç¨‹ â†’ ç»‘å®šå›è°ƒ â†’ è¿è¡Œæ§åˆ¶å¾ªç¯
  â”‚         â”‚              â”‚(åå°æŒç»­)     â”‚         â”‚
  â”‚         â”‚              â”‚               â”‚         â””â”€> è§„åˆ’+æ§åˆ¶(10Hz)
  â”‚         â”‚              â”‚               â”‚
  â”‚         â”‚              â”‚               â””â”€> æ•°æ®æ›´æ–°é€šè¿‡å›è°ƒ(50Hz)
  â”‚         â”‚              â”‚
  â”‚         â”‚              â””â”€> å¼‚æ­¥æ¥æ”¶STM32æ•°æ®
  â”‚         â”‚
  â”‚         â””â”€> æ‰“å¼€ä¸²å£
  â”‚
  â””â”€> python main_exploration.py
```

### å…³é”®è®¾è®¡æ¨¡å¼

1. **å›è°ƒæ¨¡å¼**ï¼šæ•°æ®æ¥æ”¶å¼‚æ­¥è§¦å‘
2. **å¤šçº¿ç¨‹**ï¼šæ¥æ”¶çº¿ç¨‹å’Œä¸»çº¿ç¨‹å¹¶è¡Œ
3. **ç”Ÿäº§è€…-æ¶ˆè´¹è€…**ï¼šæ¥æ”¶çº¿ç¨‹äº§ç”Ÿæ•°æ®ï¼Œæ§åˆ¶å¾ªç¯æ¶ˆè´¹æ•°æ®
4. **é…ç½®ä¸­å¿ƒ**ï¼šæ‰€æœ‰å‚æ•°åœ¨ `config.py` ç»Ÿä¸€ç®¡ç†

### ä»£ç è´¨é‡è¯„ä¼°

âœ… **ä¼˜ç‚¹ï¼š**
- æ¨¡å—åŒ–æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜
- ä½¿ç”¨ç¡¬ä»¶æ•°æ®ï¼Œå‡†ç¡®æ€§é«˜
- å‚æ•°å¯é…ç½®ï¼Œæ˜“äºè°ƒä¼˜
- å¼‚æ­¥æœºåˆ¶ï¼Œæ•ˆç‡é«˜

âš ï¸ **å¯æ”¹è¿›ï¼š**
- çº¿ç¨‹å®‰å…¨æ€§ï¼ˆè€ƒè™‘åŠ é”ä¿æŠ¤ `robot_pose`ï¼‰
- é”™è¯¯å¤„ç†ï¼ˆä¸²å£æ–­å¼€ã€æ•°æ®å¼‚å¸¸ï¼‰
- æ—¥å¿—ç³»ç»Ÿï¼ˆæ›¿æ¢printä¸ºloggingï¼‰
- å•å…ƒæµ‹è¯•ï¼ˆæ·»åŠ æµ‹è¯•ç”¨ä¾‹ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2025-01-11  
**ä½œè€…ï¼š** AI Assistant

