# xxq 完整系统测试指南

## 概述

本文档提供完整的系统测试方案，帮助您验证硬件、软件、通信等所有功能是否正常工作。

## 测试前准备

### 1. 硬件准备

- ✅ STM32开发板已连接并通电
- ✅ 电机驱动正常
- ✅ 雷达模块已连接
- ✅ MPU6500已连接
- ✅ 编码器已连接
- ✅ 蓝牙/串口通信模块正常
- ✅ 电池电量充足（建议 > 50%）

### 2. 软件准备

```bash
# 进入项目目录
cd xxq_host

# 安装依赖
pip install -r requirements.txt

# 检查配置
python config.py
```

### 3. 连接方式选择

#### 串口连接（推荐用于调试）
- ✅ 稳定性高
- ✅ 延迟低
- ✅ 数据不会丢失
- ⚠️ 需要USB线连接

#### BLE蓝牙连接（推荐用于实际运行）
- ✅ 无线，方便移动
- ✅ 适合实际场景测试
- ⚠️ 需要确保BLE设备地址正确
- ⚠️ 连接前需断开手机等其他设备

**获取BLE设备地址：**
```bash
# 扫描BLE设备
python tools/ble/scan_ble.py

# 会显示类似：
# [TARGET] HC-04BLE
#    Address: C4:25:01:20:02:8E
#    RSSI: -45 dBm
```

### 4. 环境准备

- 确保有足够的测试空间（至少 2m × 2m）
- 地面平整
- 移除障碍物（或有计划地放置障碍物）
- 准备卷尺（用于精度测试）

## 测试方案

### 方案1：快速测试（5分钟）

适用于：日常检查、快速验证

#### 串口连接：
```bash
python tests/test_system_comprehensive.py --port COM5 --quick
```

#### BLE连接：
```bash
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --quick
```

**测试内容：**
- 串口连接
- 数据接收（3秒）
- 雷达数据质量（5秒）
- MPU数据质量（3秒）
- 控制命令发送
- 通信延迟（20次）

**预期结果：** 所有测试通过，无严重错误

---

### 方案2：完整测试（20分钟）

适用于：系统集成后、重大更改后

#### 串口连接：
```bash
python tests/test_system_comprehensive.py --port COM5
```

#### BLE连接：
```bash
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E
```

**测试内容：**
1. 串口连接测试
2. 数据接收测试（5秒）
3. 传感器质量测试
   - 雷达数据质量（10秒）
   - MPU数据质量（5秒）
   - 位姿估计质量（10秒）
4. 控制命令测试
   - 模式命令
   - 速度命令
   - 响应时间
5. 通信性能测试
   - 延迟测试（50次）
   - 吞吐量测试（10秒）
6. 建图功能测试（15秒）
7. 可视化功能测试
8. 完整系统测试（30秒）

**预期结果：** 所有测试通过或大部分通过

---

### 方案3：单项测试

适用于：调试特定模块

#### 串口连接：
```bash
# 测试连接
python tests/test_system_comprehensive.py --port COM5 --test conn

# 测试雷达（验证4个扇区）
python tests/test_system_comprehensive.py --port COM5 --test lidar

# 测试MPU
python tests/test_system_comprehensive.py --port COM5 --test mpu

# 测试位姿估计
python tests/test_system_comprehensive.py --port COM5 --test pose

# 测试控制命令
python tests/test_system_comprehensive.py --port COM5 --test control

# 测试通信延迟
python tests/test_system_comprehensive.py --port COM5 --test latency

# 测试建图
python tests/test_system_comprehensive.py --port COM5 --test map

# 测试可视化
python tests/test_system_comprehensive.py --port COM5 --test viz

# 测试完整系统
python tests/test_system_comprehensive.py --port COM5 --test system
```

#### BLE连接：
```bash
# 测试连接
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test conn

# 测试雷达（验证4个扇区）
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test lidar

# 测试MPU
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test mpu

# 测试位姿估计
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test pose

# 测试控制命令
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test control

# 测试通信延迟
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test latency

# 测试建图
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test map

# 测试可视化
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test viz

# 测试完整系统
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test system
```

---

## 详细测试说明

### 1. 连接测试（串口/BLE）

**目的：** 验证主机与STM32通信是否正常

**操作：**
- 自动执行
- 无需人工干预

**通过标准：**
- ✅ 连接成功建立（串口或BLE）
- ✅ 接收线程启动

**常见问题（串口模式）：**
- ❌ "无法打开串口" → 检查端口号（Windows: COM5, Linux: /dev/ttyUSB0）
- ❌ "权限拒绝" (Linux) → 运行 `sudo chmod 666 /dev/ttyUSB0`
- ❌ "端口被占用" → 关闭其他串口程序（如STM32CubeIDE的串口监视器）

**常见问题（BLE模式）：**
- ❌ "连接超时" → 检查设备地址是否正确，运行 `python tools/ble/scan_ble.py` 重新扫描
- ❌ "设备已连接" → 断开手机或其他设备与HC-04BLE的连接
- ❌ "未找到设备" → 检查HC-04BLE是否通电，蓝牙信号是否正常
- ❌ "蓝牙未开启" → Windows设置中开启蓝牙，确保蓝牙适配器正常

---

### 2. 数据接收测试

**目的：** 验证各种传感器数据能否正常接收

**操作：**
- 自动等待5秒
- 无需人工干预

**通过标准：**
- ✅ 接收到POSE数据
- ✅ 接收到雷达数据
- ✅ 接收到MPU数据
- ✅ 接收到里程计数据

**常见问题：**
- ❌ "未收到POSE数据" → 检查固件是否启用位姿估计（main.c第318行）
- ❌ "未收到雷达数据" → 检查雷达模块连接，固件中雷达初始化
- ❌ "未收到MPU数据" → 检查MPU6500连接和I2C通信

---

### 3. 雷达数据质量测试

**目的：** 验证雷达数据准确性和稳定性

**操作：**
- 保持机器人静止
- 自动测试10秒
- 程序会周期性请求雷达扫描

**通过标准：**
- ✅ 响应率 > 30%
- ✅ 平均点数 > 10
- ✅ 覆盖角度 > 180°
- ✅ 扇区数量 = 4（简化版，适合简单迷宫）

**💡 扇区说明：**
- 已从8个扇区（每45°）优化为4个扇区（每90°）
- 4个方向：前（0°）、右（90°）、后（180°）、左（270°）
- 数据量减少约44%，传输更快
- 对简单迷宫完全够用

**常见问题：**
- ❌ "点数过少" → 检查雷达供电、环境光线
- ❌ "响应率低" → 检查串口波特率、雷达扫描频率
- ❌ "覆盖角度不足" → 检查雷达安装角度、遮挡物

**建议：**
- 在雷达周围放置障碍物（距离0.5-2米）
- 避免强光直射、黑色吸光物体

---

### 4. MPU数据质量测试

**目的：** 验证IMU数据稳定性

**操作：**
- **保持机器人完全静止**
- 测试5秒
- 不要触碰机器人

**通过标准：**
- ✅ 数据频率 > 10 Hz
- ✅ Roll标准差 < 5°（静止）
- ✅ Pitch标准差 < 5°（静止）
- ✅ 加速度约 9.8 m/s²

**常见问题：**
- ❌ "数据不稳定" → MPU6500需要校准
- ❌ "标准差过大" → 检查I2C线路、MPU固定、环境振动
- ❌ "加速度异常" → 检查MPU安装方向

**MPU校准方法：**
```c
// 固件中，在mpu6500.c中设置校准参数
// 或使用STM32提供的MPU6500校准工具
```

---

### 5. 位姿估计质量测试

**目的：** 验证卡尔曼滤波器融合精度

**操作：**
- **保持机器人完全静止**
- 测试10秒
- 观察位姿漂移

**通过标准：**
- ✅ 频率约 20 Hz
- ✅ X轴漂移 < 10 mm（10秒）
- ✅ Y轴漂移 < 10 mm（10秒）
- ✅ 角度漂移 < 2°（10秒）

**常见问题：**
- ❌ "位置漂移大" → 检查编码器参数（ENCODER_PPR）、轮径、轮距
- ❌ "角度漂移大" → MPU6500需要校准，或增大测量噪声参数
- ❌ "频率不稳定" → 检查TIM2中断频率（应为20Hz）

**参数调优：**
```python
# config.py
POSE_PROCESS_NOISE_POS = 0.01      # 打滑严重时增大
POSE_PROCESS_NOISE_THETA = 0.001   
POSE_MEASUREMENT_NOISE_THETA = 0.05 # IMU抖动时增大
```

---

### 6. 控制命令测试

**目的：** 验证命令发送和执行

**操作：**
- 自动发送多种命令
- 观察机器人反应

**通过标准：**
- ✅ 所有命令发送成功
- ✅ 机器人正确响应

**测试序列：**
1. 停止
2. 前进（1秒）
3. 停止
4. 速度控制测试

**常见问题：**
- ❌ "命令发送失败" → 检查串口状态
- ❌ "机器人无反应" → 检查电机驱动、PWM输出
- ❌ "响应延迟大" → 检查主循环频率、串口中断

---

### 7. 通信延迟测试

**目的：** 评估蓝牙/串口通信性能

**操作：**
- 自动发送50次命令
- 测量往返时间

**通过标准：**
- ✅ 平均延迟 < 50 ms（优秀）
- ✅ 平均延迟 < 100 ms（良好）
- ✅ 标准差 < 20 ms

**常见问题：**
- ❌ "延迟过高（>200ms）" → 
  - 串口波特率太低 → 改用115200或更高
  - 蓝牙模式 → HC-05延迟约50-100ms（正常）
  - USB串口 → 延迟应 < 10ms
- ❌ "延迟抖动大" → 检查主机CPU负载、固件中断优先级

**优化建议：**
- 使用USB串口而非蓝牙（调试阶段）
- 提高波特率（115200 → 230400 → 460800）
- 减少数据包大小

---

### 8. 建图功能测试

**目的：** 验证SLAM建图是否正常

**操作：**
1. 让机器人缓慢移动或原地转动
2. 测试15秒
3. 观察探索率

**通过标准：**
- ✅ 探索率 > 1%
- ✅ 空闲格子 > 100
- ✅ 障碍物格子 > 10
- ✅ 地图文件保存成功

**建议：**
- 手动推动机器人慢速前进
- 或发送MODE,1让其自动前进
- 在周围放置障碍物（椅子、箱子等）

**常见问题：**
- ❌ "探索率为0" → 雷达数据或位姿数据异常
- ❌ "只有空闲区域" → 周围没有障碍物
- ❌ "地图错乱" → 位姿估计不准确，检查编码器参数

---

### 9. 完整系统测试

**目的：** 验证整个系统运行30秒

**操作：**
- 启动控制器
- 运行30秒
- 观察行为

**通过标准：**
- ✅ 系统稳定运行
- ✅ 探索率持续增长
- ✅ 无崩溃、无异常

**常见问题：**
- ❌ "系统崩溃" → 查看错误日志，检查各模块
- ❌ "机器人不动" → 检查控制逻辑、目标点选择
- ❌ "机器人乱跑" → DWA参数需要调优

---

## 其他专项测试

### 位姿估计精度测试

```bash
# 静止漂移测试
python scripts/test_pose_estimation.py --port COM5 --test basic

# 可视化测试
python scripts/test_pose_estimation.py --port COM5 --test viz

# 精度测试（需要手动测量）
python scripts/test_pose_estimation.py --port COM5 --test accuracy
```

**精度测试步骤：**
1. 将机器人放在起点，按Enter
2. 发送MODE,1让机器人直线前进
3. 在1米处停止（MODE,0）
4. 用卷尺测量实际距离
5. 输入实际距离，程序计算误差

**通过标准：**
- ✅ 直线1米误差 < 5 cm（5%）
- ✅ 直线2米误差 < 10 cm（5%）

---

### 探索演示测试

```bash
# 简单探索
python scripts/demo_exploration.py

# 复杂探索
python scripts/demo_exploration.py --scenario complex

# 大规模探索
python scripts/demo_exploration.py --scenario large
```

---

### Web可视化测试

```bash
# 启动Web可视化
python main_exploration.py --web

# 在浏览器访问
http://localhost:5000
```

**检查项：**
- ✅ 网页能正常打开
- ✅ 地图实时更新
- ✅ 机器人位置显示正确
- ✅ 前沿点显示正确
- ✅ 轨迹绘制正常
- ✅ 操作按钮响应正常

---

## 测试结果解读

### 测试报告

测试完成后，会生成报告：
```
data/test_outputs/system_test_YYYYMMDD_HHMMSS.txt
```

### 判断标准

#### 🟢 优秀（生产就绪）
- 所有测试通过
- 通信延迟 < 50ms
- 位姿漂移 < 5mm/10s
- 雷达响应率 > 90%

#### 🟡 良好（可用）
- 核心测试通过
- 通信延迟 < 100ms
- 位姿漂移 < 50mm/10s
- 雷达响应率 > 70%

#### 🔴 需要改进
- 重要测试失败
- 通信延迟 > 200ms
- 位姿漂移 > 100mm/10s
- 雷达响应率 < 50%

---

## 常见问题排查

### 1. 连接问题

**问题：** 无法连接串口

**排查：**
```bash
# Windows
# 设备管理器 → 端口 → 查看COM号

# Linux
ls /dev/ttyUSB*
ls /dev/ttyACM*

# 查看权限
ls -l /dev/ttyUSB0

# 添加权限
sudo chmod 666 /dev/ttyUSB0
# 或永久添加
sudo usermod -a -G dialout $USER
```

---

### 2. 数据问题

**问题：** 未收到某些数据

**排查：**
1. 检查固件是否启用对应模块
2. 检查传感器硬件连接
3. 检查固件串口发送频率
4. 使用串口调试助手查看原始数据

---

### 3. 性能问题

**问题：** 系统运行卡顿

**排查：**
1. 降低可视化帧率（VISUALIZE_RATE）
2. 减小地图分辨率（MAP_RESOLUTION）
3. 降低控制循环频率
4. 检查CPU占用率

---

### 4. 精度问题

**问题：** 位姿估计不准确

**调优步骤：**

1. **确认物理参数准确**
```python
# config.py
WHEEL_BASE = 0.20      # 用卷尺精确测量
WHEEL_RADIUS = 0.033   # 用卷尺精确测量
ENCODER_PPR_LEFT = 1560   # 查看编码器规格书
ENCODER_PPR_RIGHT = 780
```

2. **校准IMU**
- 将机器人放在水平面
- 运行MPU6500校准程序
- 更新固件中的偏移值

3. **调整卡尔曼滤波参数**
```python
# config.py
# 如果打滑严重，增大过程噪声
POSE_PROCESS_NOISE_POS = 0.05  # 默认0.01

# 如果IMU抖动大，增大测量噪声
POSE_MEASUREMENT_NOISE_THETA = 0.1  # 默认0.05
```

4. **测试编码器**
```bash
# 查看编码器原始数据
# 转动车轮一圈，计数应等于ENCODER_PPR
```

---

## 测试清单

### 每日测试（5分钟）

- [ ] 快速测试通过
- [ ] 连接正常
- [ ] 传感器数据正常
- [ ] 控制命令正常

### 每周测试（20分钟）

- [ ] 完整测试通过
- [ ] 通信延迟正常
- [ ] 位姿估计精度良好
- [ ] 建图功能正常

### 重大更改后测试（30分钟）

- [ ] 完整测试通过
- [ ] 位姿精度测试通过
- [ ] 探索演示运行正常
- [ ] Web可视化正常
- [ ] 所有文档示例可运行

---

## 附录

### 测试环境推荐配置

**硬件：**
- STM32F446RE（或更高）
- 雷达：TOF或LiDAR
- IMU：MPU6500/MPU6050
- 编码器：光电编码器
- 电池：7.4V 2000mAh以上

**软件：**
- Python 3.7+
- 所有依赖包已安装
- STM32固件已烧录

**环境：**
- 测试场地：2m × 2m以上
- 光线：正常室内光线
- 地面：平整、无反光
- 障碍物：纸箱、椅子等

### 参考资料

- [硬件集成完整指南](硬件集成完整指南.md)
- [配置管理指南](配置管理指南.md)
- [测试指南](测试指南.md)
- [API文档](API文档.md)

---

## BLE连接快速参考

### 扫描BLE设备
```bash
python tools/ble/scan_ble.py
```

### 常用BLE测试命令

#### 快速测试（推荐第一次使用）
```bash
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --quick
```

#### 完整测试
```bash
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E
```

#### 单项测试示例
```bash
# 测试连接
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test conn

# 测试雷达（验证4个扇区）
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test lidar

# 测试控制
python tests/test_system_comprehensive.py --ble --address C4:25:01:20:02:8E --test control
```

### BLE连接注意事项

✅ **使用前检查：**
- 确保HC-04BLE已通电
- 断开手机等其他设备的连接
- 电脑蓝牙已开启
- 设备距离 < 10米

⚠️ **BLE vs 串口对比：**

| 特性 | 串口连接 | BLE连接 |
|------|---------|---------|
| 稳定性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 延迟 | ~10ms | ~20-50ms |
| 数据丢失 | 几乎无 | 偶尔有 |
| 便捷性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 适用场景 | 调试开发 | 实际运行 |

📝 **建议：**
- 首次测试使用**串口连接**，确保功能正常
- 功能验证后切换到**BLE连接**，测试实际场景

---

## 技术支持

如遇到问题，请按以下顺序排查：

1. 查看本文档的"常见问题"部分
2. 查看 `doc/` 目录下的相关文档
3. 查看测试报告中的详细错误信息
4. 查看代码中的注释和日志
5. 在GitHub仓库提交Issue

**祝测试顺利！** 🎉

